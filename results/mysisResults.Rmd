---
title: "Mysis analysis"
author: "John Tipton"
date: "September 9, 2015"
output: html_document
---
```{r loadLibraries, echo=FALSE, include=FALSE, message=FALSE}
library(knitr)
library(ggplot2)
library(Gmisc)
library(MASS)
library(stringr)
library(mgcv)
library(lme4)
```
## Model for Total counts for each net
```{r totalCount, echo=FALSE, include=FALSE, message=FALSE, cache=TRUE}
set.seed(123)
data_one_way <- read.csv("~/mysis/data/ttestData.csv", skip = 3, nrows = 40, header = TRUE)
count <- c(data_one_way$full.5,  ## count for full net
            4 * data_one_way$half.5) ## count for half net adjusted for radius
date <- rep(as.factor(data_one_way$month), 2)
station <- rep(data_one_way$Station, 2)
net <- as.factor(c(rep("full", 40), rep("half", 40)))
data <- data.frame(count=count, date=date, net=net)
X <- model.matrix(~ net * date)
ggplot(data=data, aes(count)) + geom_histogram() + facet_grid(net ~ .)
summary(nbmod <- glm.nb(y ~ . -1, data = data.frame(y=count, X)))
# summary(qpmod <- glmmPQL(count ~ net * date, random=~1|station, family=neg.bin(2.6)))
# summary(glmmPQL(count ~ net * date, random=~1|station, family=neg.bin(0.1))) 
# summary(glmmPQL(count ~ net * date, random=~1|station, family=neg.bin(10)))
coefs <- c(nbmod$coefficients, nbmod$theta)
```

To test for a change in total counts between the two net sizes, we construct a negative binomal regression model that examines the effects of net size, date of sampling and the interaction between net size and sampling date. The results shown below show that there is no evidence of an effect on the number of counts observed between the two net sizes (p=`r I(round(summary(nbmod)$coef[2, 4], 4))`).


```{r countModelResults, echo=FALSE, cache=TRUE}
tableData <- cbind(summary(nbmod)$coeff[1:6, ])
colnames(tableData) <- c("Estimate", "Std. Error", "z value", "Pr(>|z|)")
rownames(tableData) <- c("Intercept", "Net Size", "August", "September", 
                         "Net Size * August", "Net Size * September")
# htmlTable(x=round(tableData, digits=2),
#           caption=paste("Negative Binomial Regression parameter estimates"),
#           header = c("  Estimate  ", "  Std. Error  ", "  z value  ", "  p-value  "),
#           rowlabel = "Variable",
#           rnames = c("Intercept",
#                     "Net Size",
#                     "August",
#                     "September",
#                     "Net Size * August",
#                     "Net Size * September"))
kable(tableData, digits = 4, format="pandoc")
```

## Model for counts by gender
```{r, echo=FALSE, include=FALSE, message=FALSE, cache=TRUE}
set.seed(123)
fullData <- read.csv("~/mysis/data/lengthData.csv", skip=4)

males <- rep(0, 80)
females <- rep(0, 80)
juveniles <- rep(0, 80)
unknowns <- rep(0, 80)
size <- rep(0, 80)
date_tmp <- rep(0, 80)

idx <- 1
for(i in unique(fullData$Sample.Label)){
  tmp_data = subset(fullData, fullData$Sample.Label == i)
  tmp = substr(as.character(tmp_data$Gender), 0, 1)
  males[idx] <- sum(tmp == "M")
  juveniles[idx] <- sum(tmp == "J")
  females[idx] <- sum(tmp == "F")
  unknowns[idx] <- sum(tmp == "U")
  size[idx] <- tmp_data$Size..m.[1]
  date_tmp[idx] <- tmp_data$Date[1]
  idx <- idx + 1
}

## construct count vector
count <- c(males, females, juveniles, unknowns)
gender <- factor(rep(1:4, each=80))
## Correct for mislabeling
date_tmp[70] <- 4
date_tmp[72] <- 4
date <- rep(0, 80)
date[date_tmp == 1] <- 1
date[date_tmp == 2] <- 1
date[date_tmp == 3] <- 2
date[date_tmp == 4] <- 3

date <- as.factor(date)
net <- as.factor(size)
count[rep(net, times=4) == 0.5] <- count[rep(net, times=4) == 0.5] * 4
data <- data.frame(count=count, date=rep(date, times=4), net=rep(net, times=4), gender=gender)
# X <- model.matrix(~ net * date + net * gender + gender * date, data=data)
X <- model.matrix(~ net * gender + date, data=data)
ggplot(data=data, aes(count)) + geom_histogram() + facet_grid(net ~ gender)
ggplot(data=data, aes(count)) + geom_histogram() + facet_grid(net ~ date)
ggplot(data=data, aes(count)) + geom_histogram() + facet_grid(gender ~ date)
nbmod <- glm.nb(y ~ . -1, data = data.frame(y=count, X))
```

To test for a change in counts broken down by gender category between the two net sizes, we construct a negative binomal regression model that examines the effects of net size, date of sampling and the interaction between net size and sampling date. The results shown below show that there is no evidence of an effect on the number of counts observed between the two net sizes (p=`r I(round(summary(nbmod)$coef[2, 4], 4))`).

```{r sexResults, echo=FALSE, cache=TRUE}


tableData <- cbind(summary(nbmod)$coeff)
colnames(tableData) <- c("Estimate", "Std. Error", "z value", "Pr(>|z|)")
rownames(tableData) <- c("Intercept", "Net Size", "Females", "Juveniles", 
                         "Unknown Gender", "August", "September", 
                         "Net Size * Females", "Net Size * Juveniles", 
                         "Net Size * Unknowns")


kable(tableData, digits = 4, format="pandoc")
```


## Model for proportion of juveniles
```{r, echo=FALSE, include=FALSE, message=FALSE, cache=TRUE}
set.seed(123)
data_one_way <- read.csv("~/mysis/data/ttestData.csv", skip = 3, nrows = 40,
                         header = TRUE, stringsAsFactors=FALSE)

prop <- c(as.numeric(data_one_way$full.2),    ## proportion of females full net
             as.numeric(data_one_way$half.2)) ## proportion of females half net
N <- length(prop)
## Set improper values to NA

date <- rep(as.factor(data_one_way$month), 2)
net <- as.factor(c(rep("full", 40), rep("half", 40)))
data <- data.frame(prop=prop, date=date, net=net)
X <- model.matrix(~ net * date)
ggplot(data=data, aes(prop)) + geom_histogram() + facet_grid(net ~ .)
library(betareg)
brmod <- betareg(prop ~ . -1, data = data.frame(prop, X))
summary(brmod)
```

To test for a change in the proportion of juveniles caught between the two net sizes, we construct a beta regression model that examines the effects of net size, date of sampling and the interaction between net size and sampling date. The results shown below show that there is no evidence of an effect on the proportion of juveniles caught between the two net sizes (p=`r I(round(summary(brmod)$coef$mean[2, 4], 4))`).

```{r juvenileResults, echo=FALSE, cache=TRUE}
tableData <- cbind(summary(brmod)$coeff$mean)
colnames(tableData) <- c("Estimate", "Std. Error", "z value", "Pr(>|z|)")
rownames(tableData) <- c("Intercept", "Net Size", "August", "September", 
                         "Net Size * August", "Net Size * September")
kable(tableData, digits = 4, format="pandoc")
```

## Length model

```{r, echo=FALSE, include=FALSE, message=FALSE, cache=TRUE}
set.seed(123)
data_length <- read.csv("~/mysis/data/lengthData.csv", skip = 4, header = TRUE)
net <- data_length$Size..m.
y <- data_length$Length..mm.
gender <- as.factor(substr(str_trim(as.character(data_length$Gender)), 0, 1))
                       ## remove whitespace from string, then truncate into 
                       ## broad gender classes, not subclasses

date <- as.numeric(data_length$Date)
date[date == 2] <- 1      ## collapse into monthly values
date[date == 3] <- 2
date[date == 4] <- 3
date <- as.factor(date)
station <- data_length$Station
# plot(as.numeric(date), type='l', main = "Is this a data error? - yes?")
## correct date mislabeling
date <- as.numeric(data_length$Date)
date[7330:7519] <- 4
date[7559:7773] <- 4
date[date == 2] <- 1      ## collapse into monthly values
date[date == 3] <- 2
date[date == 4] <- 3
date <- as.factor(date)
# plot(as.numeric(date), type='l', main = "Data looks better")
data <- data.frame(y=y, date=date, net=net, gender=gender)
X <- model.matrix(~ net + date + gender, data=data)
ggplot(data=data, aes(y)) + geom_histogram() + facet_grid(net ~ date)
idx <- attr(uniquecombs(X), "index")
summary(lmmod <- lm(y ~ net + date + gender))
library(lme4)
summary(lmemod <- lmer(y ~ net + date + gender + (1|station)))
rlmmod <- rlm(y ~ net + date + gender)
```


```{r lengthResults, echo=FALSE, cache=TRUE}
tableData <- cbind(summary(lmmod)$coeff)
colnames(tableData) <- c("Estimate", "Std. Error", "z value", "Pr(>|z|)")
rownames(tableData) <- c("Intercept", "Net Size", "August", "September", 
                         "Juvenile", "Male", "Unknown Gender")
kable(tableData, digits = 4, format="pandoc")

# plot(lmmod)
# summary(rlmmod)
# plot(rlmmod)
# kruskal.test(y ~ net)
```